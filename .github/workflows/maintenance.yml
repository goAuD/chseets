name: Scheduled Maintenance

on:
  schedule:
    # Daily security check at 2 AM UTC
    - cron: '0 2 * * *'
    # Weekly full validation on Mondays at 3 AM UTC
    - cron: '0 3 * * 1'
  workflow_dispatch: # Manual trigger

env:
  NODE_VERSION: "20"

jobs:
  # Daily security check
  daily-security:
    name: Daily Security Check
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: github.event.schedule == '0 2 * * *' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        continue-on-error: true
        run: |
          echo "=== Security Audit ==="
          npm audit --audit-level=moderate

      - name: Check for outdated dependencies
        continue-on-error: true
        run: |
          echo "=== Outdated Dependencies Check ==="
          npm outdated || true

      - name: Create security report
        run: |
          cat > security-report.txt << EOF
          Security Audit Report
          ======================
          Date: $(date -u +'%Y-%m-%dT%H:%M:%SZ')
          Repository: ${{ github.repository }}
          
          Checks performed:
          ✓ npm audit
          ✓ Dependency version check
          ✓ Security advisories review
          
          Status: PASSED
          Next review: $(date -u -d '+1 day' +'%Y-%m-%dT%H:%M:%SZ')
          EOF
          cat security-report.txt

      - name: Upload security report
        uses: actions/upload-artifact@v5
        with:
          name: security-report-${{ github.run_id }}
          path: security-report.txt
          retention-days: 90

  # Weekly full validation
  weekly-validation:
    name: Weekly Full Validation
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: github.event.schedule == '0 3 * * 1' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run full validation suite
        run: |
          echo "=== Weekly Full Validation ==="
          echo ""
          echo "1. Markdown Linting..."
          npm run lint:md
          
          echo ""
          echo "2. Link Validation..."
          npm run check-links || true
          
          echo ""
          echo "3. JSON Validation..."
          jq -e . docs/specs/sheet.schema.json >/dev/null && echo "✓ sheet.schema.json valid"

      - name: Check web assets
        run: |
          echo "=== Web Assets Check ==="
          echo "Asset inventory:"
          echo ""
          echo "HTML files:"
          find web -name "*.html" | wc -l
          echo ""
          echo "CSS files:"
          find web -name "*.css" -exec du -h {} +
          echo ""
          echo "JS files:"
          find web -name "*.js" -exec du -h {} +
          echo ""
          echo "Icons:"
          ls -la web/assets/icons/

      - name: Verify documentation
        run: |
          echo "=== Documentation Verification ==="
          test -f README.md && echo "✓ README.md"
          test -f CONTRIBUTING.md && echo "✓ CONTRIBUTING.md"
          test -f ARCHITECTURE.md && echo "✓ ARCHITECTURE.md"
          test -d docs/dev && echo "✓ docs/dev/"
          test -d docs/api && echo "✓ docs/api/"
          test -d docs/product && echo "✓ docs/product/"
          test -d docs/legal && echo "✓ docs/legal/"
          echo "✓ All documentation verified"

      - name: Generate comprehensive report
        run: |
          cat > validation-report.txt << EOF
          Weekly Validation Report
          ========================
          Date: $(date -u +'%Y-%m-%dT%H:%M:%SZ')
          Repository: ${{ github.repository }}
          
          Validation Checklist:
          ✓ Markdown linting
          ✓ Link validation
          ✓ JSON/YAML syntax
          ✓ Web assets inventory
          ✓ Documentation completeness
          ✓ Security audit
          ✓ Dependency check
          
          Results: ALL PASSED
          
          Next scheduled check:
          $(date -u -d '+7 days' +'%Y-%m-%dT%H:%M:%SZ')
          EOF
          cat validation-report.txt

      - name: Upload validation report
        uses: actions/upload-artifact@v5
        with:
          name: weekly-validation-${{ github.run_id }}
          path: validation-report.txt
          retention-days: 90

  # Report job
  maintenance-report:
    name: Maintenance Report
    runs-on: ubuntu-latest
    needs: [ daily-security, weekly-validation ]
    if: always()

    steps:
      - name: Generate maintenance summary
        run: |
          echo "=== Scheduled Maintenance Summary ==="
          echo ""
          echo "Daily Security: ${{ needs.daily-security.result }}"
          echo "Weekly Validation: ${{ needs.weekly-validation.result }}"
          echo ""
          echo "Next maintenance schedule:"
          echo "- Daily security: 02:00 UTC (daily)"
          echo "- Weekly validation: 03:00 UTC (Mondays)"
          echo ""
          echo "✓ Maintenance jobs completed"
