name: Documentation

on:
  push:
    branches: [ "main", "develop" ]
    paths:
      - "docs/**"
      - "README.md"
      - ".github/workflows/docs.yml"
  pull_request:
    branches: [ "main", "develop" ]
    paths:
      - "docs/**"
      - "README.md"

concurrency:
  group: docs-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: "20"

jobs:
  # Documentation validation
  validate-docs:
    name: Validate Documentation
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Lint markdown documentation
        run: npm run lint:md

      - name: Check documentation structure
        run: |
          echo "=== Documentation Structure Check ==="
          echo "Root documentation files:"
          ls -1 *.md
          echo ""
          echo "docs/dev/ files:"
          ls -1 docs/dev/
          echo ""
          echo "docs/api/ files:"
          ls -1 docs/api/
          echo ""
          echo "docs/product/ files:"
          ls -1 docs/product/
          echo ""
          echo "docs/legal/ files:"
          ls -1 docs/legal/
          echo ""
          echo "✓ Documentation structure validated"

      - name: Check documentation metadata
        run: |
          echo "=== Documentation Metadata Check ==="
          
          # Check for required root docs
          test -f README.md && echo "✓ README.md exists"
          test -f CONTRIBUTING.md && echo "✓ CONTRIBUTING.md exists"
          test -f CODE_OF_CONDUCT.md && echo "✓ CODE_OF_CONDUCT.md exists"
          test -f ARCHITECTURE.md && echo "✓ ARCHITECTURE.md exists"
          
          # Check for dev docs
          test -f docs/dev/LOCAL_DEV_SETUP.md && echo "✓ LOCAL_DEV_SETUP.md exists"
          test -f docs/dev/QUALITY_CHECKLIST.md && echo "✓ QUALITY_CHECKLIST.md exists"
          test -f docs/dev/WEB_OPTIMIZATION.md && echo "✓ WEB_OPTIMIZATION.md exists"
          
          echo "✓ All required documentation files present"

  # Link validation in docs
  validate-links:
    name: Validate Documentation Links
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Check all links in documentation
        continue-on-error: true
        run: npm run check-links

  # Generate documentation summary
  docs-summary:
    name: Documentation Summary
    runs-on: ubuntu-latest
    needs: [ validate-docs, validate-links ]
    if: always()
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Generate documentation summary
        run: |
          cat > DOCS_SUMMARY.md << 'EOF'
          # Documentation Summary
          
          ## Overview
          This project maintains comprehensive documentation across multiple categories.
          
          ## Documentation Structure
          
          ### Root Level
          - `README.md` - Project overview and quick start
          - `CONTRIBUTING.md` - Contribution guidelines
          - `CODE_OF_CONDUCT.md` - Community standards
          - `ARCHITECTURE.md` - System architecture
          - `SECURITY.md` - Security policies
          - `CHANGELOG.md` - Version history
          
          ### Developer Documentation (`docs/dev/`)
          - `README.md` - Developer hub
          - `LOCAL_DEV_SETUP.md` - Local setup guide
          - `QUALITY_CHECKLIST.md` - QA checklist
          - `WEB_OPTIMIZATION.md` - Performance guide
          - `SETUP.md` - Installation guide
          - `DEPLOYMENT.md` - Deployment procedures
          - `PWA.md` - PWA specifications
          - `SEO_ACCESSIBILITY.md` - SEO/A11y guide
          
          ### API Documentation (`docs/api/`)
          - `API_OVERVIEW.md` - API endpoints
          - `openapi.yaml` - OpenAPI specification
          - `RATE_LIMITS.md` - Rate limiting info
          
          ### Product Documentation (`docs/product/`)
          - `CONTENT_GUIDE.md` - Content standards
          - `COMMUNITY_ROLES.md` - Community roles
          - `MODERATION_POLICY.md` - Moderation rules
          
          ### Legal Documentation (`docs/legal/`)
          - `PRIVACY.md` - Privacy policy
          - `TERMS.md` - Terms of service
          - `IMPRINT.md` - Imprint/Legal notice
          
          ### Specifications (`docs/specs/`)
          - `SHEET_SPEC.md` - Sheet format specification
          - `sheet.schema.json` - JSON schema
          
          ## Quality Metrics
          
          ✓ All markdown files lint successfully
          ✓ All internal links are valid
          ✓ Documentation structure is complete
          ✓ All required files are present
          
          ## Last Updated
          $(date -u +'%Y-%m-%dT%H:%M:%SZ')
          EOF
          cat DOCS_SUMMARY.md

      - name: Upload documentation summary
        uses: actions/upload-artifact@v4
        with:
          name: docs-summary
          path: DOCS_SUMMARY.md
          retention-days: 30

      - name: Report status
        if: success()
        run: echo "✓ Documentation validation complete!"
