# =============================================================================
# chseets CI/CD Pipeline
# =============================================================================
# 
# ARCHITECTURE:
#   - CI job: GitHub-hosted runner (ubuntu-latest) - basic validation
#   - Deploy job: Self-hosted runner (Debian) - rsync to Caddy webroot
#
# SECURITY NOTES (PUBLIC REPO):
#   - Self-hosted runner ONLY runs on:
#     - push to main branch
#     - manual workflow_dispatch
#   - NO self-hosted execution on: pull_request, forks, external contributors
#   - PRs from forks would run CI on GitHub-hosted only (if ever needed)
#
# INFRASTRUCTURE:
#   - Runner: chseets-debian-01
#   - Runner path: /home/goaud/actions-runner-chseets
#   - Webroot: /srv/www/chseets
#   - User: goaud (with NOPASSWD sudo for rsync, systemctl, etc.)
#
# =============================================================================

name: CI/CD Pipeline

on:
  # Push to main triggers full pipeline (CI + Deploy)
  push:
    branches:
      - main
  
  # Manual deploy trigger
  workflow_dispatch:

# Prevent concurrent deployments
concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # ===========================================================================
  # JOB 1: CI (Basic validation)
  # ===========================================================================
  # Runs on GitHub-hosted runner - safe for any event type
  # This is a vanilla HTML/CSS/JS site - no build step required
  # ===========================================================================
  ci:
    name: CI (Basic check)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate critical files exist
        run: |
          echo "üîç Validating critical files..."
          
          # Check required files exist
          test -f web/index.html && echo "‚úÖ web/index.html exists" || { echo "‚ùå web/index.html missing"; exit 1; }
          test -f web/manifest.json && echo "‚úÖ web/manifest.json exists" || { echo "‚ùå web/manifest.json missing"; exit 1; }
          test -f web/sw.js && echo "‚úÖ web/sw.js exists" || { echo "‚ùå web/sw.js missing"; exit 1; }
          test -f web/assets/css/wasd.css && echo "‚úÖ web/assets/css/wasd.css exists" || { echo "‚ùå web/assets/css/wasd.css missing"; exit 1; }
          test -f web/assets/js/app.js && echo "‚úÖ web/assets/js/app.js exists" || { echo "‚ùå web/assets/js/app.js missing"; exit 1; }
          
          echo ""
          echo "‚úÖ CI validation passed - all critical files present"

      - name: List web directory structure
        run: |
          echo "üìÅ Web directory structure:"
          find web -type f | head -50

  # ===========================================================================
  # JOB 2: Deploy to Debian Server
  # ===========================================================================
  # Runs on self-hosted runner - ONLY on push to main or manual dispatch
  # Uses rsync to sync web/ folder to /srv/www/chseets
  # Excludes .git, .github, and other non-production files
  # ===========================================================================
  deploy:
    name: Deploy to Debian (Caddy webroot)
    needs: ci
    runs-on:
      - self-hosted
      - chseets
    
    # SECURITY: Only run on push to main or manual dispatch
    # Never runs on pull_request or fork events
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Display deployment info
        run: |
          echo "üöÄ Starting deployment..."
          echo "========================================"
          echo "  Repository: ${{ github.repository }}"
          echo "  Branch:     ${{ github.ref_name }}"
          echo "  Commit:     ${{ github.sha }}"
          echo "  Trigger:    ${{ github.event_name }}"
          echo "  Runner:     chseets-debian-01"
          echo "  Target:     /srv/www/chseets"
          echo "========================================"

      - name: Deploy with rsync
        run: |
          echo "üì¶ Syncing web/ to /srv/www/chseets..."
          
          # rsync the web/ folder contents to Caddy webroot
          # --archive: preserve permissions, timestamps, symlinks
          # --verbose: show progress
          # --delete: remove files in target that are not in source
          # --exclude: skip non-production files
          sudo rsync -av --delete \
            --exclude ".git" \
            --exclude ".github" \
            --exclude "node_modules" \
            --exclude ".DS_Store" \
            --exclude "*.md" \
            --exclude "docs" \
            web/ /srv/www/chseets/
          
          echo "‚úÖ Files synced successfully"

      - name: Reload Caddy
        run: |
          echo "üîÑ Reloading Caddy..."
          sudo systemctl reload caddy
          echo "‚úÖ Caddy reloaded"

      - name: Verify deployment
        run: |
          echo "üîç Verifying deployment..."
          
          # Check key files exist in webroot
          test -f /srv/www/chseets/index.html && echo "‚úÖ index.html deployed" || echo "‚ùå index.html missing"
          test -f /srv/www/chseets/manifest.json && echo "‚úÖ manifest.json deployed" || echo "‚ùå manifest.json missing"
          test -f /srv/www/chseets/sw.js && echo "‚úÖ sw.js deployed" || echo "‚ùå sw.js missing"
          
          echo ""
          echo "========================================"
          echo "  ‚úÖ DEPLOYMENT COMPLETE"
          echo "  Site: https://chseets.com"
          echo "  Time: $(date -u +'%Y-%m-%dT%H:%M:%SZ')"
          echo "========================================"
