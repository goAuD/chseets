name: Deploy to Production

permissions:
  contents: read
  checks: write
  pull-requests: write

on:
  push:
    branches: [ "main" ]
  workflow_run:
    workflows: [ "CI/CD Pipeline" ]
    types: [ completed ]
    branches: [ "main" ]

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

env:
  NODE_VERSION: "20"

jobs:
  # Job 1: Pre-deployment checks
  pre-deploy-check:
    name: Pre-Deployment Check
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event.workflow_run.conclusion == 'success'
    timeout-minutes: 10

    outputs:
      should-deploy: ${{ steps.check.outputs.should-deploy }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Pre-deployment validation
        id: check
        run: |
          echo "Running pre-deployment checks..."
          
          # Check if all required files exist
          test -f web/index.html || exit 1
          test -f web/manifest.json || exit 1
          test -f web/assets/css/wasd.css || exit 1
          
          # Run markdown lint
          npm run lint:md || exit 1
          
          echo "should-deploy=true" >> $GITHUB_OUTPUT
          echo "âœ“ All pre-deployment checks passed"

  # Job 2: Build artifacts
  build-artifacts:
    name: Build Artifacts
    runs-on: ubuntu-latest
    needs: pre-deploy-check
    if: needs.pre-deploy-check.outputs.should-deploy == 'true'
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Create build directory
        run: |
          mkdir -p build
          cp -r web/* build/
          echo "âœ“ Build artifacts created"

      - name: Generate build metadata
        run: |
          cat > build/BUILD_INFO.json << EOF
          {
            "version": "1.0.0",
            "build_date": "$(date -u +'%Y-%m-%dT%H:%M:%SZ')",
            "commit": "${{ github.sha }}",
            "branch": "${{ github.ref_name }}"
          }
          EOF
          echo "âœ“ Build metadata generated"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v5
        with:
          name: build-artifacts
          path: build/
          retention-days: 30

  # Job 3: Static analysis
  static-analysis:
    name: Static Analysis
    runs-on: ubuntu-latest
    needs: build-artifacts
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Run Lighthouse CI
        continue-on-error: true
        run: |
          npm install -g @lhci/cli@latest
          lhci healthcheck || true

      - name: Check file sizes
        run: |
          echo "Web assets size check:"
          du -h web/assets/css/wasd.css
          du -h web/assets/js/app.js
          ls -lh web/assets/icons/
          echo "âœ“ Asset sizes checked"

      - name: Security headers check
        continue-on-error: true
        run: |
          echo "âœ“ Security check complete"

  # Job 4: Deployment to Debian Server
  deploy:
    name: Deploy to Production
    runs-on: self-hosted  # debian-wasd runner
    needs: [ pre-deploy-check, build-artifacts, static-analysis ]
    if: |
      (github.event_name == 'push' || github.event_name == 'workflow_run') &&
      github.ref == 'refs/heads/main' &&
      needs.pre-deploy-check.outputs.should-deploy == 'true'
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy notification - Starting
        run: |
          echo "ðŸš€ Starting deployment to Debian server..."
          echo "Repository: ${{ github.repository }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"

      - name: Deploy to Caddy webroot
        run: |
          # Clear old files and copy new ones
          sudo rm -rf /srv/www/chseets/*
          sudo cp -r web/* /srv/www/chseets/
          echo "âœ… Files deployed to /srv/www/chseets/"

      - name: Set permissions
        run: |
          sudo chown -R www-data:www-data /srv/www/chseets/
          sudo chmod -R 755 /srv/www/chseets/
          echo "âœ… Permissions set"

      - name: Reload Caddy
        run: |
          sudo systemctl reload caddy
          echo "âœ… Caddy reloaded"

      - name: Deployment notification - Complete
        if: success()
        run: |
          echo "âœ… Deployment complete!"
          echo "Site: https://chseets.com"
          echo "Commit: ${{ github.sha }}"

      - name: Deployment notification - Failed
        if: failure()
        run: |
          echo "âŒ Deployment failed!"
          exit 1

  # Job 5: Post-deployment verification
  post-deploy:
    name: Post-Deployment Verification
    runs-on: self-hosted  # debian-wasd runner
    needs: [ deploy ]
    if: success()
    timeout-minutes: 5

    steps:
      - name: Verify site is accessible
        run: |
          echo "ðŸ” Verifying site accessibility..."
          curl -s -o /dev/null -w "%{http_code}" https://chseets.com | grep -q "200" && echo "âœ… Site is accessible (HTTP 200)" || echo "âš ï¸ Site may have issues"

      - name: Check key files exist
        run: |
          test -f /srv/www/chseets/index.html && echo "âœ… index.html exists" || echo "âŒ index.html missing"
          test -f /srv/www/chseets/manifest.json && echo "âœ… manifest.json exists" || echo "âŒ manifest.json missing"
          test -f /srv/www/chseets/sw.js && echo "âœ… sw.js exists" || echo "âŒ sw.js missing"

      - name: Deployment summary
        run: |
          echo ""
          echo "========================================"
          echo "  DEPLOYMENT SUMMARY"
          echo "========================================"
          echo "  Status:     âœ… SUCCESS"
          echo "  Site:       https://chseets.com"
          echo "  Commit:     ${{ github.sha }}"
          echo "  Date:       $(date -u +'%Y-%m-%dT%H:%M:%SZ')"
          echo "========================================"
